(()=>{var t={257:(t,n,e)=>{const r=e(896),o=JSON.parse(r.readFileSync("./cred.json","utf8"));t.exports=o},788:(t,n,e)=>{function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function o(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,i(r.key),r)}}function i(t){var n=function(t,n){if("object"!=r(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var o=e.call(t,n||"default");if("object"!=r(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==r(n)?n:String(n)}function a(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */a=function(){return n};var t,n={},e=Object.prototype,o=e.hasOwnProperty,i=Object.defineProperty||function(t,n,e){t[n]=e.value},c="function"==typeof Symbol?Symbol:{},s=c.iterator||"@@iterator",u=c.asyncIterator||"@@asyncIterator",p=c.toStringTag||"@@toStringTag";function d(t,n,e){return Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}),t[n]}try{d({},"")}catch(t){d=function(t,n,e){return t[n]=e}}function l(t,n,e,r){var o=n&&n.prototype instanceof D?n:D,a=Object.create(o.prototype),c=new A(r||[]);return i(a,"_invoke",{value:b(t,e,c)}),a}function m(t,n,e){try{return{type:"normal",arg:t.call(n,e)}}catch(t){return{type:"throw",arg:t}}}n.wrap=l;var E="suspendedStart",f="suspendedYield",h="executing",y="completed",O={};function D(){}function I(){}function N(){}var S={};d(S,s,(function(){return this}));var v=Object.getPrototypeOf,R=v&&v(v(M([])));R&&R!==e&&o.call(R,s)&&(S=R);var T=N.prototype=D.prototype=Object.create(S);function L(t){["next","throw","return"].forEach((function(n){d(t,n,(function(t){return this._invoke(n,t)}))}))}function g(t,n){function e(i,a,c,s){var u=m(t[i],t,a);if("throw"!==u.type){var p=u.arg,d=p.value;return d&&"object"==r(d)&&o.call(d,"__await")?n.resolve(d.__await).then((function(t){e("next",t,c,s)}),(function(t){e("throw",t,c,s)})):n.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return e("throw",t,c,s)}))}s(u.arg)}var a;i(this,"_invoke",{value:function(t,r){function o(){return new n((function(n,o){e(t,r,n,o)}))}return a=a?a.then(o,o):o()}})}function b(n,e,r){var o=E;return function(i,a){if(o===h)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var c=r.delegate;if(c){var s=w(c,r);if(s){if(s===O)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===E)throw o=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=h;var u=m(n,e,r);if("normal"===u.type){if(o=r.done?y:f,u.arg===O)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=y,r.method="throw",r.arg=u.arg)}}}function w(n,e){var r=e.method,o=n.iterator[r];if(o===t)return e.delegate=null,"throw"===r&&n.iterator.return&&(e.method="return",e.arg=t,w(n,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),O;var i=m(o,n.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,O;var a=i.arg;return a?a.done?(e[n.resultName]=a.value,e.next=n.nextLoc,"return"!==e.method&&(e.method="next",e.arg=t),e.delegate=null,O):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,O)}function C(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function F(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function A(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function M(n){if(n||""===n){var e=n[s];if(e)return e.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var i=-1,a=function e(){for(;++i<n.length;)if(o.call(n,i))return e.value=n[i],e.done=!1,e;return e.value=t,e.done=!0,e};return a.next=a}}throw new TypeError(r(n)+" is not iterable")}return I.prototype=N,i(T,"constructor",{value:N,configurable:!0}),i(N,"constructor",{value:I,configurable:!0}),I.displayName=d(N,p,"GeneratorFunction"),n.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===I||"GeneratorFunction"===(n.displayName||n.name))},n.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,N):(t.__proto__=N,d(t,p,"GeneratorFunction")),t.prototype=Object.create(T),t},n.awrap=function(t){return{__await:t}},L(g.prototype),d(g.prototype,u,(function(){return this})),n.AsyncIterator=g,n.async=function(t,e,r,o,i){void 0===i&&(i=Promise);var a=new g(l(t,e,r,o),i);return n.isGeneratorFunction(e)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},L(T),d(T,p,"Generator"),d(T,s,(function(){return this})),d(T,"toString",(function(){return"[object Generator]"})),n.keys=function(t){var n=Object(t),e=[];for(var r in n)e.push(r);return e.reverse(),function t(){for(;e.length;){var r=e.pop();if(r in n)return t.value=r,t.done=!1,t}return t.done=!0,t}},n.values=M,A.prototype={constructor:A,reset:function(n){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(F),!n)for(var e in this)"t"===e.charAt(0)&&o.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var e=this;function r(r,o){return c.type="throw",c.arg=n,e.next=r,o&&(e.method="next",e.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],c=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var s=o.call(a,"catchLoc"),u=o.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(t,n){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=n,i?(this.method="next",this.next=i.finallyLoc,O):this.complete(a)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),O},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),F(e),O}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.tryLoc===t){var r=e.completion;if("throw"===r.type){var o=r.arg;F(e)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(n,e,r){return this.delegate={iterator:M(n),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=t),O}},n}function c(t,n,e,r,o,i,a){try{var c=t[i](a),s=c.value}catch(t){return void e(t)}c.done?n(s):Promise.resolve(s).then(r,o)}function s(t){return function(){var n=this,e=arguments;return new Promise((function(r,o){var i=t.apply(n,e);function a(t){c(i,r,o,a,s,"next",t)}function s(t){c(i,r,o,a,s,"throw",t)}a(void 0)}))}}var u=e(581),p=e(875),d=function(t,n,e){console.log("".concat(n,": ").concat(e)),t.status(n),t.send(e)},l=function(){var t=s(a().mark((function t(n,e,r){var o,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=n.body,i=o.id,r.query('\n    SELECT users.id, users.name, roles.id as roleID, roles.name as roleName, roles.index as roleIndex\n      FROM (\n          SELECT id, name, phone, email, "folk-member" as roleID FROM community\n          UNION\n          SELECT id, name, phone, email, roleID FROM incumbents\n      ) AS users\n    JOIN roles ON users.roleID=roles.id\n    WHERE phone = \''.concat(i,"' or email = '").concat(i,"';")).then((function(t){t?t.length?(e.status(200),e.send(t)):d(e,404,"User not found"):d(e,500,"Unknown error while verifying user. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 3:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),m=function(){var t=s(a().mark((function t(n,e){var r;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=n.body,u.send(r).then((function(t){var n=t.status,r=t.error;e.status(n).send(r)})).catch((function(t){console.log(t),d(e,500,t)}));case 2:case"end":return t.stop()}}),t)})));return function(n,e){return t.apply(this,arguments)}}(),E=function(){var t=s(a().mark((function t(n,e){var r;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=n.body,u.verify(r).then((function(t){var n=t.status,r=t.error;e.status(n).send(r)})).catch((function(t){d(e,500,t)}));case 2:case"end":return t.stop()}}),t)})));return function(n,e){return t.apply(this,arguments)}}(),f=function(){var t=s(a().mark((function t(n,e,r){var o,i,c,s,u;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=n.body,i=o.filename,c=o.imageDataURL,s=c.split(";base64,").pop(),u=Buffer.from(s,"base64"),p.put(i,u).then((function(){e.send()})).catch((function(t){d(e,500,"Could not set user photo: ".concat(t))}));case 5:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),h=function(){var t=s(a().mark((function t(n,e,r){var o,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=n.body,i=o.id,r.query("SELECT * FROM community WHERE buddy='".concat(i,"' order by name;")).then((function(t){t?(e.status(200),e.send(t)):d(e,500,"Unknown error while fetching buddy list. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 3:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),y=function(){var t=s(a().mark((function t(n,e,r){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.query("SELECT community.*, buddies.name AS buddyName, IFNULL(roles.roleID, 'folk-member') AS roleID FROM community LEFT JOIN (SELECT * FROM incumbents WHERE roleID = 'buddy-coord') buddies ON buddies.id = community.buddy LEFT JOIN (SELECT * FROM incumbents WHERE roleID = 'buddy-coord') AS roles ON roles.id = community.id ORDER BY community.name;").then((function(t){t?(e.status(200),e.send(t)):d(e,500,"Unknown error while fetching community members. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 1:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),O=function(){var t=s(a().mark((function t(n,e,r){var o,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=n.body,i=o.id,r.query('SELECT assignees.*, IFNULL(incumbents.roleID, "folk-member") as roleID, IFNULL(roles.name, "FOLK Member") as roleName, IFNULL(roles.index, 9) as roleIndex FROM\n  (SELECT community.*, community.buddy as buddyID, incumbents.name as buddyName, incumbents.phone as buddyPhone FROM community\n  LEFT JOIN incumbents on incumbents.id=community.buddy\n  WHERE community.preacher=\''.concat(i,"') as assignees\n  LEFT JOIN incumbents on incumbents.id=assignees.id\n  LEFT JOIN roles on roles.id=incumbents.roleID\n  ORDER BY roleIndex, assignees.name")).then((function(t){t?(e.status(200),e.send(t)):d(e,500,"Unknown error while fetching assignees list. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 3:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),D=function(){var t=s(a().mark((function t(n,e,r){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.query("\n  SELECT startDate as date FROM calendar WHERE startDate<=NOW() AND courseID IS NOT NULL ORDER BY startDate DESC LIMIT 1;\n\n  SELECT COUNT(community.id) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m1.date IS NULL);\n\n  SELECT COUNT(community.id) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m2.date IS NULL);\n\n  SELECT community.tShirtSize as shirt, COUNT(community.tShirtSize) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m2.date IS NULL) AND community.tShirtSize IS NOT NULL GROUP BY community.tShirtSize ORDER BY shirt;\n\n\n\n  SELECT COUNT(community.id) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m1.date IS NULL) AND count.sessions>=3;\n\n  SELECT COUNT(community.id) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m2.date IS NULL) AND count.sessions>=6;\n\n  SELECT community.tShirtSize as shirt, COUNT(community.tShirtSize) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m2.date IS NULL) AND count.sessions>=6 AND community.tShirtSize IS NOT NULL GROUP BY community.tShirtSize ORDER BY shirt;\n\n\n\n  SELECT COUNT(community.id) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m1.date is NULL AND count.sessions>=3) AND community.id IN (SELECT participantID FROM participation JOIN calendar ON calendar.id=participation.eventID WHERE calendar.startDate=(SELECT startDate FROM calendar WHERE startDate<=NOW() AND courseID IS NOT NULL ORDER BY startDate DESC LIMIT 1)) ORDER BY community.name;\n\n  SELECT COUNT(community.id) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m2.date is NULL AND count.sessions>=6) AND community.id IN (SELECT participantID FROM participation JOIN calendar ON calendar.id=participation.eventID WHERE calendar.startDate=(SELECT startDate FROM calendar WHERE startDate<=NOW() AND courseID IS NOT NULL ORDER BY startDate DESC LIMIT 1)) ORDER BY community.name;\n\n  SELECT community.tShirtSize as shirt, COUNT(community.tShirtSize) as count FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND (m2.date is NULL AND count.sessions>=6) AND community.id IN (SELECT participantID FROM participation JOIN calendar ON calendar.id=participation.eventID WHERE calendar.startDate=(SELECT startDate FROM calendar WHERE startDate<=NOW() AND courseID IS NOT NULL ORDER BY startDate DESC LIMIT 1)) AND community.tShirtSize IS NOT NULL GROUP BY community.tShirtSize ORDER BY shirt;\n\n  \n\n  SELECT community.id, community.name, community.phone, community.tShirtSize, CASE WHEN m1.date IS NULL THEN TRUE ELSE FALSE END AS gift, CASE WHEN m2.date IS NULL THEN CASE WHEN count.sessions>=6 THEN TRUE ELSE FALSE END ELSE FALSE END AS cert, count.sessions FROM community LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-0') m1 ON m1.participantID=community.id LEFT JOIN (SELECT * FROM progress WHERE endowmentID = 'SOS-1') m2 ON m2.participantID=community.id LEFT JOIN (SELECT count.participantID, COUNT(count.code) AS sessions FROM (SELECT DISTINCT participation.participantID, sessions.code FROM participation JOIN calendar ON participation.eventID=calendar.id JOIN sessions ON sessions.id=calendar.sessionID WHERE participation.attendance=1 AND calendar.courseID='SOS' ORDER BY participation.participantID) count GROUP BY count.participantID) count ON count.participantID=community.id WHERE community.courseID='SOS' AND ((m1.date is NULL AND count.sessions>=3) OR (m2.date is NULL AND count.sessions>=6)) AND community.id IN (SELECT participantID FROM participation JOIN calendar ON calendar.id=participation.eventID WHERE calendar.startDate=(SELECT startDate FROM calendar WHERE startDate<=NOW() AND courseID IS NOT NULL ORDER BY startDate DESC LIMIT 1)) AND attendance=1 ORDER BY cert, count.sessions desc, community.name;").then((function(t){t?(e.status(200),e.send(t)):d(e,500,"Unknown error while fetching gifts list. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 1:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),I=function(){var t=s(a().mark((function t(n,e,r){var o,i,c,s;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=n.body,i=o.id,c=o.roleID,s=function(t,n){return"folk-member"===n?"SELECT member.*, incumbents.name AS buddyName, incumbents.phone AS buddyPhone, courses.name AS courseName, session.sessionCount, course.sessionAttendance, comp.completion FROM (SELECT community.id, community.name, community.preacher AS preacherID, community.buddy AS buddyID, community.attendance, community.courseID, incumbents.name AS preacherName, incumbents.phone AS preacherPhone FROM community LEFT JOIN incumbents ON incumbents.id=community.preacher WHERE community.id='".concat(t,"' AND incumbents.roleID='folk-guide') member LEFT JOIN incumbents ON incumbents.id=member.buddyID AND incumbents.roleID='buddy-coord' LEFT JOIN courses ON courses.id=member.courseID LEFT JOIN (SELECT courseID, COUNT(code) AS sessionCount FROM (SELECT DISTINCT code, courseID FROM sessions) session GROUP BY courseID) session ON session.courseID=member.courseID LEFT JOIN (SELECT session.courseID, COUNT(session.code) AS sessionAttendance FROM (SELECT DISTINCT sessions.code, calendar.courseID FROM participation JOIN calendar ON calendar.id=participation.eventID JOIN sessions ON sessions.id = calendar.sessionID WHERE participantID='").concat(t,"' AND participation.attendance=1 AND calendar.courseID IS NOT NULL) session GROUP BY session.courseID) course ON course.courseID=member.courseID LEFT JOIN (SELECT DISTINCT participantID, completion FROM progress JOIN endowments ON endowments.id=progress.endowmentID WHERE completion=1 AND courseID=(SELECT courseID FROM community WHERE id='").concat(t,"')) comp ON comp.participantID=member.id;\n\n        SELECT calendar.startDate as date, sessions.name FROM participation JOIN calendar ON calendar.id=participation.eventID AND participation.attendance=1 JOIN sessions ON calendar.sessionID=sessions.id WHERE participantID='").concat(t,"' AND calendar.courseID=(SELECT courseID FROM community WHERE id='").concat(t,"') ORDER BY calendar.startDate;\n\n        SELECT sessions.id, sessions.name, attendance.date FROM sessions LEFT JOIN (SELECT sessions.id, MAX(calendar.startDate) AS date FROM participation JOIN calendar ON calendar.id=participation.eventID JOIN sessions ON calendar.sessionID=sessions.id WHERE participantID='").concat(t,"' AND attendance=1 GROUP BY sessions.id) attendance ON attendance.id=sessions.id WHERE courseID=(SELECT courseID FROM community WHERE id='").concat(t,"') AND type!='CATCHUP' ORDER BY sessions.index;\n\n        SELECT calendar.startDate as date, calendar.courseID, calendar.name FROM participation JOIN calendar ON calendar.id=participation.eventID AND participation.attendance=1 WHERE participantID='").concat(t,"' ORDER BY calendar.startDate;\n        \n        SELECT endowments.title, milestones.date FROM endowments LEFT JOIN (SELECT * FROM progress JOIN endowments ON endowments.id=progress.endowmentID WHERE participantID='").concat(t,"') milestones ON endowments.id=milestones.id WHERE endowments.courseID=(SELECT courseID FROM community WHERE id='").concat(t,"') ORDER BY endowments.index;"):""},r.query(s(i,c)).then((function(t){t?(e.status(200),e.send(t||[])):d(e,500,"Unknown error while fetching home data. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 4:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),N={"/verify-user":l,"/send-otp":m,"/verify-otp":E,"/set-user-photo":f,"/get-community":y,"/get-buddies":h,"/get-assignees":O,"/get-users":function(){var t=s(a().mark((function t(n,e,r){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.query('\n    SELECT users.id, users.name, users.phone, roles.id as roleID, roles.name as roleName, roles.index as roleIndex\n      FROM (\n          SELECT id, name, phone, email, "folk-member" as roleID FROM community\n          UNION\n          SELECT id, name, phone, email, roleID FROM incumbents\n      ) AS users\n    JOIN roles ON users.roleID=roles.id\n    ORDER BY roleIndex asc, users.name asc;').then((function(t){t?t.length?(e.status(200),e.send(t)):d(e,404,"No users found"):d(e,500,"Unknown error while fetching users. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 1:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}(),"/get-gifts":D,"/get-home-data":I,"/get-catchup-data":function(){var t=s(a().mark((function t(n,e,r){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.query('\n    SELECT community.id, community.phone, community.name, CASE WHEN LEAST(community.date, MIN(calendar.startDate)) < DATE_SUB(CURDATE(), INTERVAL 2 MONTH) THEN DATE_SUB(CURDATE(), INTERVAL 2 MONTH) ELSE LEAST(community.date, MIN(calendar.startDate)) END AS date FROM community JOIN participation ON participation.participantID=community.id JOIN calendar ON calendar.id=participation.eventID WHERE community.id IN (SELECT id FROM community WHERE courseID!="FEC" AND courseID!="") GROUP BY community.name;\n\n    SELECT community.id, calendar.id as eventID, community.name, community.phone, calendar.startDate AS date, sessions.name AS sessionName, sessions.code, participation.attendance FROM participation JOIN calendar ON calendar.id=participation.eventID JOIN sessions ON sessions.id=calendar.sessionID JOIN community ON community.id=participation.participantID WHERE participation.participantID IN (SELECT id FROM community WHERE courseID!="FEC" AND courseID!="" ORDER BY name) AND calendar.courseID=\'SOS\' ORDER BY participation.participantID, calendar.startDate;\n    \n    SELECT sessions.code, sessions.name, calendar.startDate AS date, calendar.startTime, calendar.endTime FROM calendar JOIN sessions ON sessions.id=calendar.sessionID WHERE calendar.startDate=(SELECT MIN(calendar.startDate) FROM calendar JOIN sessions ON sessions.id = calendar.sessionID WHERE calendar.startDate>NOW() AND sessions.type="CATCHUP") AND calendar.courseID=\'SOS\' AND sessions.type="CATCHUP" ORDER BY calendar.startTime;\n\n    SELECT calendar.id as eventID, calendar.startDate AS date, sessions.code, sessions.name FROM calendar JOIN sessions ON sessions.id = calendar.sessionID WHERE calendar.startDate > (SELECT MIN(mindate.date) AS date FROM (SELECT LEAST(community.date, MIN(calendar.startDate)) AS date FROM community JOIN participation ON participation.participantID=community.id JOIN calendar ON calendar.id=participation.eventID WHERE community.id IN (SELECT id FROM community WHERE courseID!="FEC" AND courseID!="") GROUP BY community.name) mindate) AND calendar.startDate < NOW() AND calendar.courseID=\'SOS\' ORDER BY calendar.startDate;\n  ').then((function(t){t?t.length?(e.status(200),e.send(t)):d(e,404,"No users found"):d(e,500,"Unknown error while fetching catchup data. Got undefined or null result")})).catch((function(t){d(e,500,t)}));case 1:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}()},S=function(){function t(n){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),this.db=n}var n,e,r,i;return n=t,e=[{key:"call",value:(i=s(a().mark((function t(n,e){var r,o;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=n.get("endpoint"),o=n.get("user"),console.log("[API] [".concat(o||"NO-USER","] ").concat(r)),r in N?N[r](n,e,this.db):d(e,400,"Endpoint ".concat(r," not found"));case 4:case"end":return t.stop()}}),t,this)}))),function(t,n){return i.apply(this,arguments)})}],e&&o(n.prototype,e),r&&o(n,r),Object.defineProperty(n,"prototype",{writable:!1}),t}();t.exports=S},875:(t,n,e)=>{var r=e(257),o="https://cdn.iskconmysore.org/content?path=folkapp/dp",i=e(938),a={head:function(t){return new Promise((function(n,e){i.head("".concat(o,"/").concat(t)).then((function(){n()})).catch((function(t){return e("Error during CDN HEAD request: ".concat(t.message))}))}))},put:function(t,n){return new Promise((function(e,a){i.put("".concat(o,"/").concat(t),n,{headers:{"Content-Type":"image/jpeg","api-key":r.cdn.apiKey}}).then((function(){e("File updated successfully")})).catch((function(t){return a("Error during CDN PUT request: ".concat(t.message))}))}))},delete:function(t){return new Promise((function(n,e){i.delete("".concat(o,"/").concat(t),{headers:{"api-key":r.cdn.apiKey}}).then((function(){n("File deleted successfully")})).catch((function(t){return e("Error during CDN DELETE request: ".concat(t.message))}))}))}};t.exports=a},992:t=>{function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function e(t,n){for(var e=0;e<n.length;e++){var o=n[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,r(o.key),o)}}function r(t){var e=function(t,e){if("object"!=n(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var o=r.call(t,e||"default");if("object"!=n(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==n(e)?e:String(e)}var o=function(){function t(n){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),this.db=n}var n,r,o;return n=t,(r=[{key:"query",value:function(t){var n=this;return new Promise((function(e,r){n.db.query(t,(function(t,n){if(t)return r(t);e(n)}))}))}},{key:"close",value:function(){this.db.end()}}])&&e(n.prototype,r),o&&e(n,o),Object.defineProperty(n,"prototype",{writable:!1}),t}();t.exports=o},581:(t,n,e)=>{var r=e(257),o="https://otp.iskconmysore.org/data",i=e(938),a={send:function(t){var n=t.id,e=t.target;return new Promise((function(t,a){i.post(o,{id:n,target:e,title:"OTP from FOLK Mysore App"},{headers:{"Content-Type":"application/json","api-key":r.otp.apiKey,endpoint:"/send"}}).then((function(){t({status:200})})).catch((function(n){console.log("".concat(n)),t({status:n&&n.response&&n.response.status,error:n&&n.message})}))}))},verify:function(t){var n=t.otp,e=t.id;return new Promise((function(t,a){i.post(o,{otp:n,id:e},{headers:{"Content-Type":"application/json","api-key":r.otp.apiKey,endpoint:"/verify"}}).then((function(){t({status:200})})).catch((function(n){console.log("".concat(n)),t({status:n&&n.response&&n.response.status,error:n&&n.message})}))}))}};t.exports=a},771:(t,n,e)=>{function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function o(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */o=function(){return n};var t,n={},e=Object.prototype,i=e.hasOwnProperty,a=Object.defineProperty||function(t,n,e){t[n]=e.value},c="function"==typeof Symbol?Symbol:{},s=c.iterator||"@@iterator",u=c.asyncIterator||"@@asyncIterator",p=c.toStringTag||"@@toStringTag";function d(t,n,e){return Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}),t[n]}try{d({},"")}catch(t){d=function(t,n,e){return t[n]=e}}function l(t,n,e,r){var o=n&&n.prototype instanceof D?n:D,i=Object.create(o.prototype),c=new A(r||[]);return a(i,"_invoke",{value:b(t,e,c)}),i}function m(t,n,e){try{return{type:"normal",arg:t.call(n,e)}}catch(t){return{type:"throw",arg:t}}}n.wrap=l;var E="suspendedStart",f="suspendedYield",h="executing",y="completed",O={};function D(){}function I(){}function N(){}var S={};d(S,s,(function(){return this}));var v=Object.getPrototypeOf,R=v&&v(v(M([])));R&&R!==e&&i.call(R,s)&&(S=R);var T=N.prototype=D.prototype=Object.create(S);function L(t){["next","throw","return"].forEach((function(n){d(t,n,(function(t){return this._invoke(n,t)}))}))}function g(t,n){function e(o,a,c,s){var u=m(t[o],t,a);if("throw"!==u.type){var p=u.arg,d=p.value;return d&&"object"==r(d)&&i.call(d,"__await")?n.resolve(d.__await).then((function(t){e("next",t,c,s)}),(function(t){e("throw",t,c,s)})):n.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return e("throw",t,c,s)}))}s(u.arg)}var o;a(this,"_invoke",{value:function(t,r){function i(){return new n((function(n,o){e(t,r,n,o)}))}return o=o?o.then(i,i):i()}})}function b(n,e,r){var o=E;return function(i,a){if(o===h)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var c=r.delegate;if(c){var s=w(c,r);if(s){if(s===O)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===E)throw o=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=h;var u=m(n,e,r);if("normal"===u.type){if(o=r.done?y:f,u.arg===O)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=y,r.method="throw",r.arg=u.arg)}}}function w(n,e){var r=e.method,o=n.iterator[r];if(o===t)return e.delegate=null,"throw"===r&&n.iterator.return&&(e.method="return",e.arg=t,w(n,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),O;var i=m(o,n.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,O;var a=i.arg;return a?a.done?(e[n.resultName]=a.value,e.next=n.nextLoc,"return"!==e.method&&(e.method="next",e.arg=t),e.delegate=null,O):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,O)}function C(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function F(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function A(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function M(n){if(n||""===n){var e=n[s];if(e)return e.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var o=-1,a=function e(){for(;++o<n.length;)if(i.call(n,o))return e.value=n[o],e.done=!1,e;return e.value=t,e.done=!0,e};return a.next=a}}throw new TypeError(r(n)+" is not iterable")}return I.prototype=N,a(T,"constructor",{value:N,configurable:!0}),a(N,"constructor",{value:I,configurable:!0}),I.displayName=d(N,p,"GeneratorFunction"),n.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===I||"GeneratorFunction"===(n.displayName||n.name))},n.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,N):(t.__proto__=N,d(t,p,"GeneratorFunction")),t.prototype=Object.create(T),t},n.awrap=function(t){return{__await:t}},L(g.prototype),d(g.prototype,u,(function(){return this})),n.AsyncIterator=g,n.async=function(t,e,r,o,i){void 0===i&&(i=Promise);var a=new g(l(t,e,r,o),i);return n.isGeneratorFunction(e)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},L(T),d(T,p,"Generator"),d(T,s,(function(){return this})),d(T,"toString",(function(){return"[object Generator]"})),n.keys=function(t){var n=Object(t),e=[];for(var r in n)e.push(r);return e.reverse(),function t(){for(;e.length;){var r=e.pop();if(r in n)return t.value=r,t.done=!1,t}return t.done=!0,t}},n.values=M,A.prototype={constructor:A,reset:function(n){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(F),!n)for(var e in this)"t"===e.charAt(0)&&i.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var e=this;function r(r,o){return c.type="throw",c.arg=n,e.next=r,o&&(e.method="next",e.arg=t),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],c=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var s=i.call(a,"catchLoc"),u=i.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(t,n){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=n&&n<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=n,o?(this.method="next",this.next=o.finallyLoc,O):this.complete(a)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),O},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),F(e),O}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.tryLoc===t){var r=e.completion;if("throw"===r.type){var o=r.arg;F(e)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(n,e,r){return this.delegate={iterator:M(n),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=t),O}},n}function i(t,n,e,r,o,i,a){try{var c=t[i](a),s=c.value}catch(t){return void e(t)}c.done?n(s):Promise.resolve(s).then(r,o)}function a(t){return function(){var n=this,e=arguments;return new Promise((function(r,o){var a=t.apply(n,e);function c(t){i(a,r,o,c,s,"next",t)}function s(t){i(a,r,o,c,s,"throw",t)}c(void 0)}))}}function c(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,r)}return e}function s(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?c(Object(e),!0).forEach((function(n){u(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):c(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}function u(t,n,e){var o;return o=function(t,n){if("object"!=r(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var o=e.call(t,n||"default");if("object"!=r(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(n,"string"),(n="symbol"==r(o)?o:String(o))in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}var p=e(716),d=e(257),l=new(e(209))(d.telebot.botToken,{polling:!1}),m=[{table:"community",update:function(t,n){var e=n.attendance,r=n.lastAttended,o=n.regularity,i=n.status;return"UPDATE community SET attendance = ".concat(e,", lastAttended = ").concat(r?"'".concat(r,"'"):"null",", regularity = ").concat(o,", status = '").concat(i,"' WHERE id = '").concat(t,"';")},queries:[{query:function(t){return"\n                    SELECT COUNT(*) AS attendance FROM participation JOIN calendar ON calendar.id = participation.eventID WHERE participation.participantID = '".concat(t,"' AND participation.attendance = 1 AND calendar.courseID IS NOT NULL;\n                ")},post:function(t){return t[0].attendance}},{query:function(t){return"\n                    SELECT MAX(calendar.startDate) AS lastAttended FROM participation JOIN calendar ON calendar.id = participation.eventID WHERE participation.participantID = '".concat(t,"' AND participation.attendance = 1 AND calendar.courseID IS NOT NULL;\n                ")},post:function(t){return t[0].lastAttended}},{query:function(t){return"\n                    SELECT CAST(COUNT(*) / (SELECT COUNT(DISTINCT startDate) FROM calendar WHERE startDate BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AND CURDATE() AND courseID IS NOT NULL AND startDate >= (SELECT date FROM community WHERE id = '".concat(t,"')) * 100 AS SIGNED) AS regularity FROM participation JOIN calendar ON calendar.id = participation.eventID WHERE participation.participantID = '").concat(t,"' AND calendar.courseID IS NOT NULL AND calendar.startDate IN (SELECT DISTINCT startDate FROM calendar WHERE startDate BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AND CURDATE() AND courseID IS NOT NULL) AND participation.attendance = 1;\n                ")},post:function(t){return t[0].regularity}},{query:function(t){return"\n                    SELECT date, snooze, courseID from community where id='".concat(t,"';\n                ")},post:function(t){return t[0]}}],derivatives:[{name:"status",compute:function(t){var n=t.attendance,e=t.regularity,r=t.date,o=t.snooze,i=t.courseID,a=p().diff(p(r,"YYYY-MM-DD"),"days");return i?o>=p().format("YYYY-MM-DD")?"Snooze":a<=7&&0==n?"New":e>=75?"Regular":e>0?"Irregular":"Inactive":"NA"}}]}],E=function(t,n,e){return new Promise((function(r,o){n.query(t.queries.map((function(t){return t.query(e).trim()})).join(" ")).then((function(n){var o={};n.forEach((function(t){o=s(s({},t[0]),o)})),t.derivatives.forEach((function(t){o[t.name]=t.compute(o)})),r(t.update(e,o))})).catch((function(t){o(t)}))}))},f={compute:function(){var t=a(o().mark((function t(n,e,r){var i;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=m.filter((function(t){return t.table==n}))[0],!r){t.next=9;break}return t.t0=e,t.next=5,E(i,e,r);case 5:t.t1=t.sent,t.t0.query.call(t.t0,t.t1).catch((function(t){console.log("[STATS ERROR] ".concat(t)),l.sendMessage(d.telebot.apiChatID,"[STATS ERROR] ".concat(t))})),t.next=10;break;case 9:e.query("SELECT id FROM ".concat(n)).then(function(){var t=a(o().mark((function t(n){var r,a;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=[],a=0;case 2:if(!(a<n.length)){t.next=11;break}return t.t0=r,t.next=6,E(i,e,n[a].id);case 6:t.t1=t.sent,t.t0.push.call(t.t0,t.t1);case 8:a++,t.next=2;break;case 11:e.query(r.join(" ")).catch((function(t){console.log("[STATS ERROR] ".concat(t)),l.sendMessage(d.telebot.apiChatID,"[STATS ERROR] ".concat(t))}));case 12:case"end":return t.stop()}}),t)})));return function(n){return t.apply(this,arguments)}}()).catch((function(t){console.log("[STATS ERROR] ".concat(t)),l.sendMessage(d.telebot.apiChatID,"[STATS ERROR] ".concat(t))}));case 10:case"end":return t.stop()}}),t)})));return function(n,e,r){return t.apply(this,arguments)}}()};t.exports=f},949:(t,n,e)=>{var r=e(938),o=e(257),i=e(771),a=new(e(209))(o.telebot.botToken,{polling:!1}),c=["Community","Courses","Sessions","Calendar","Participation"],s={community:["id","date","name","phone","email","preacher","buddy","courseID","category","source","dob","snooze","comments","yearOfJoining","skills","institution","tShirtSize","native","isStudent","course","company","designation"],participation:["participantID","eventID","caller","phone","response","time","attendance","remarks","name"],calendar:["id","startDate","endDate","startTime","endTime","name","courseID","speaker","venue","cost","type","sessionID","felicitation","hidden","remarks"],incumbents:["id","name","phone","email","roleID"],courses:["id","name","level"],sessions:["courseID","name","message","id","type","code","index","canvaLink","videoLink"]},u=["comments","remarks","skills","remarks","message"],p=[{id:"PVPD",name:"Pavana Prana Dasa",phone:"6364903722",email:"pvpd@iskconmysore.org",roleID:"app-admin"},{id:"PVPD",name:"Pavana Prana Dasa",phone:"6364903722",email:"pvpd@iskconmysore.org",roleID:"folk-guide"},{id:"SKKD",name:"Sanaka Kumara Dasa",phone:"6364903726",email:"skkd@iskconmysore.org",roleID:"folk-guide"},{id:"KSD",name:"Karunya Sagar Dasa",phone:"9880544450",email:"ksd@iskconmysore.org",roleID:"folk-guide"},{id:"9488329061",name:"Yashas H",phone:"9488329061",email:"yashasmane@gmail.com",roleID:"folk-exec"}];Array.prototype.insert=function(t,n){return"INSERT INTO ".concat(t," (").concat(this.map((function(t){return"`".concat(t,"`")})).join(", "),") VALUES (").concat(this.map((function(t){return e=n[t],r=t,"boolean"==typeof e||e||(e=null),-1!=u.indexOf(r)&&e&&(e=Buffer.from(e).toString("base64")),null==e?"NULL":"string"==typeof e?'"'.concat(e.replace(/"/g,"'"),'"'):"boolean"==typeof e?e?1:0:e;var e,r})).join(", "),")")};t.exports=function(t){console.log("[SYNC]","sync started"),r.post("https://sheets.iskconmysore.org",{url:"https://docs.google.com/spreadsheets/d/186h3EpvZSvCD8Mcn7NU9TN70BGz_BZtKlSXGHVH_laU/edit#",sheets:c}).then((function(n){console.log("[SYNC]","received sheet data");var e=n.data;t.query("\n\n      BEGIN;\n\n      ".concat([].concat(c).reverse().map((function(t){return"DELETE FROM ".concat(t.toLowerCase())})).join("; "),";\n\n      DELETE FROM incumbents;\n      DELETE FROM progress;\n\n      ").concat(c.map((function(t){return t=t.toLowerCase(),e[t].map((function(n){return s[t].insert(t,n)})).join("; ")})).join("; "),";\n\n      ").concat(e.community.filter((function(t){return"Buddy Coordinator"==t.buddyName})).concat(p).map((function(t){var n=t.id,e=t.name,r=t.phone,o=t.email;return s.incumbents.insert("incumbents",{id:n,name:e,phone:r,email:o,roleID:t.roleID||"buddy-coord"})})).join("; "),";\n\n      ").concat(e.community.filter((function(t){return t.giftDate||t.certDate})).map((function(t){return"\n        ".concat(t.giftDate?"INSERT INTO iskconmy_folk.progress (participantID, endowmentID, date) VALUES('".concat(t.id,"','SOS-0','").concat(t.giftDate,"');"):"","\n        ").concat(t.certDate?"INSERT INTO iskconmy_folk.progress (participantID, endowmentID, date) VALUES('".concat(t.id,"','SOS-1','").concat(t.certDate,"');"):"","\n      ").trim()})).join(""),"\n      \n      COMMIT;\n    ").trim()).then((function(n){console.log("[SYNC]","sync complete, updating stats.."),i.compute("community",t),console.log("[SYNC]","Stats updation will be completed shortly!")})).catch((function(t){var n=t&&t.response&&t.response.data?t.response.data:t&&t.response?t.response:t;a.sendMessage(o.telebot.apiChatID,"[SYNC ERROR]\n".concat(n)),console.log("[SYNC] ".concat(n))}))})).catch((function(t){console.log("[SYNC] ".concat(t))}))}},393:(t,n,e)=>{var r=e(716),o=e(938),i=e(257),a=new(e(209))(i.telebot.botToken,{polling:!1});t.exports=function(t){t.query("SELECT name, phone, preacher, dob FROM community WHERE dob LIKE '%".concat(r().format("-MM-DD"),"'")).then((function(t){t.length?(console.log("[WISH]","".concat(t.length," wishes today..")),t.forEach((function(t){var n=t.name,e=t.phone,r=t.preacher,c=n.split(" ")[0],s="SKKD"==r?"Sanaka Kumar Dasa":"Pavana Prana Dasa";o.post("https://wame.iskconmysore.org",{template:"wishmitra",phone:e,values:[c,s],headers:["https://cdn.iskconmysore.org/content?path=folkapp/assets/wish.png"]},{headers:{"api-key":i.wame.apiKey}}).then((function(){console.log("[WISH]","Wish sent to ".concat(n," (").concat(e,")")),a.sendMessage(i.telebot.wishChatID,"Below wish is sent to ".concat(n," (").concat(e,")\n\n").concat("Hare Krishna {{1}} !! ðŸŒŸðŸŽ‰\n\nWishing you a very happy Krishna Conscious birthday!! ðŸŽ‚ May Their Lordships Sri Sri Krishna Balaram shower upon you Their choicest blessings âœ¨\n\nMake this day special by visiting our temple ðŸ›• and having a divine darshan of the Lord. ðŸ™\n\nWith heartfelt wishes,\n{{2}}".replace("{{1}}",c).replace("{{2}}",s)))})).catch((function(t){console.log("[WISH]","Wish error: ".concat(t)),a.sendMessage(i.telebot.wishChatID,"Wish error: ".concat(t))}))}))):(console.log("[WISH]","No birthdays today!"),a.sendMessage(i.telebot.wishChatID,"No birthdays today!"))})).catch((function(t){console.log("[WISH] Wish error: ".concat(t)),a.sendMessage(i.telebot.wishChatID,"Wish error: ".concat(t))}))}},938:t=>{"use strict";t.exports=require("axios")},252:t=>{"use strict";t.exports=require("express")},716:t=>{"use strict";t.exports=require("moment")},874:t=>{"use strict";t.exports=require("mysql")},703:t=>{"use strict";t.exports=require("node-cron")},209:t=>{"use strict";t.exports=require("node-telegram-bot-api")},896:t=>{"use strict";t.exports=require("fs")}},n={};function e(r){var o=n[r];if(void 0!==o)return o.exports;var i=n[r]={exports:{}};return t[r](i,i.exports,e),i.exports}(()=>{var t=e(716),n=console.log;console.log=function(){for(var e=(new Date).toISOString(),r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];n.apply(console,["[".concat(t(e).format("YY-MMM-DD HH:mm"),"]")].concat(o))};var r=e(252),o=e(703),i=r();i.use(r.json({limit:"10mb"}));var a=e(788),c=e(992),s=e(257),u=e(949),p=e(393);s.mysql.connectionLimit=100,s.mysql.multipleStatements=!0;var d=new c(e(874).createPool(s.mysql)),l=new a(d);if(i.get("/api",(function(t,n){n.status(200).send()})),i.post("/api",l.call.bind(l)),i.listen(3005,(function(){console.log("App listening at http://localhost:".concat(3005))})),s.cron.sync){var m=t().add(1,"minute").format("mm");console.log("Sync minute - ".concat(m)),o.schedule("".concat(m," * * * *"),(function(){u(d)}))}s.cron.wish&&o.schedule("0 4 * * *",(function(){p(d)}))})()})();